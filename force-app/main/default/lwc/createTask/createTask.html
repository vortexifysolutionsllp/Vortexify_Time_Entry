<template>
    <template if:true={showSpinner}>
        <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
    </template>
    <lightning-card title="Task Dashboard" icon-name="standard:task">
        <lightning-button slot="actions" label="+ Create Task" variant="brand" onclick={openCreateModal}>
        </lightning-button>

        <div class="slds-p-around_medium"
            style="border-top:2px solid rgb(214, 214, 214);padding-left:0.8%;padding-right:0.6%;overflow-y:scroll;">
            <div class="task-grid">
                <template if:true={isTasksAvailable} for:each={tasks} for:item="task">
                    <div key={task.id} class="custom-card">

                        <!-- HEADER : ICON + TITLE + ACTION ICONS -->
                        <div class="card-header">
                            <div class="left-section">
                                <span class="icon">ðŸ“…</span>
                                <span class="title">{task.name}</span>
                            </div>

                            <div class="header-actions">
                                <button class="circle-btn view-btn" data-id={task.id} onclick={openReadOnlyPopup}>
                                    <lightning-icon icon-name="utility:preview" size="x-small" data-id={task.id} onclick={openReadOnlyPopup}></lightning-icon>
                                </button>


                                <button class="circle-btn edit-btn" data-id={task.id} onclick={handleEdit}>
                                <lightning-icon icon-name="utility:edit" size="x-small" data-id={task.id} onclick={handleEdit}></lightning-icon>
                            </button>
                                <button class="circle-btn delete-btn" data-id={task.id} onclick={handleDelete}>
                                <lightning-icon icon-name="utility:delete" size="x-small" data-id={task.id} onclick={handleDelete}></lightning-icon>
                            </button>
                            <button class="circle-btn edit-btn" data-id={task.id} onclick={handleClone}>
                                <lightning-icon icon-name="utility:copy" size="x-small" data-id={task.id} onclick={handleClone}></lightning-icon>
                            </button>

                                <!-- <lightning-button-icon 
    icon-name="utility:edit"
    variant="bare"
    class="icon-circle edit-circle"
    data-id={task.id}
    onclick={handleEdit}>
</lightning-button-icon>

<lightning-button-icon 
    icon-name="utility:delete"
    variant="bare"
    class="icon-circle delete-circle"
    data-id={task.id}
    onclick={handleDelete}>
</lightning-button-icon> -->


                            </div>


                        </div>

                        <div class="row">
                            <p><strong>Project : </strong>{task.project}</p>
                        </div>

                        <div class="description">
                            <p>
                                <strong>Description : </strong>
                                {task.shortDescription}

                                <template if:true={task.hasMore}>
                                    ...
                                </template>
                            </p>
                        </div>

                        <div class="row">
                            <p><strong>Assigned By : </strong>{task.owner}</p>
                        </div>

                        <div class="row">
                            <p><strong>Assign To : </strong>{task.AssignTo}</p>
                        </div>

                    </div>
                </template>
                <template if:false={isTasksAvailable}>
                    <div class="empty-task-container">
                        <img
                            src={emptyTaskImage}
                            alt="No tasks available"
                            class="empty-task-image"
                        />

                        <!-- <h2 class="empty-task-title">
                            Lucky Day! ðŸŽ‰
                        </h2>

                        <p class="empty-task-subtitle">
                            No task assigned to you today
                        </p>

                        <lightning-button
                            label="Create New Task"
                            variant="brand"
                            onclick={handleCreateTask}
                            class="create-task-btn">
                        </lightning-button> -->
                    </div>
                </template>
            </div>

        </div>

        <!-- Unified Create/Edit Modal -->
        <template if:true={isModalOpen}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open" style="z-index: 1 !important;">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <h2 class="slds-text-heading_medium">{modalTitle}</h2>
                    </header>

                    <div class="slds-modal__content slds-p-around_medium">
                        <div class="slds-grid slds-wrap slds-gutters">
                            <div class="slds-col slds-size_1-of-2">
                                <template if:false={isEditMode}>
                                    <label class="lookup-label">
        Select Project <span class="required">*</span>
    </label>
                                    <c-custom-lookup object-api-name="Project__c" placeholder="Search Project"
                                        onrecordselect={handleProjectChange} selected-id={selectedProject}
                                        selected-name={selectedProject}>
                                    </c-custom-lookup>
                                    <!-- <c-custom-lookup label="Select Project" object-api-name="Project__c"
                                        placeholder="Search Project" onrecordselect={handleProjectChange}
                                        selected-id={selectedProject} selected-name={selectedProject}>
                                    </c-custom-lookup> -->
                                </template>
                                <template if:true={isEditMode}>
                                    <lightning-input label="Project" value={selectedProject} disabled required>
                                    </lightning-input>
                                </template>
                            </div>
                            <!-- <div class="slds-col slds-size_1-of-2">
                                <c-custom-lookup label="Select Project" object-api-name="Project__c"
                                    placeholder="Search Project" onrecordselect={handleProjectChange}
                                    selected-id={selectedProject} selected-name={selectedProject}
                                    disabled={isEditMode}></c-custom-lookup>
                            </div> -->

                            <!-- <div class="slds-col slds-size_1-of-2"> -->
                            <!-- <c-custom-lookup label="Select Module" object-api-name="Module__c"
                                    placeholder="Search Module" onrecordselect={handleModuleChange}
                                    selected-id={selectedModule} selected-name={selectedModuleName} disabled={isEditMode}></c-custom-lookup> -->
                            <!-- <c-custom-lookup label="Select Module"
                                        object-api-name="Module__c"
                                        placeholder="Search Module"
                                        records-list={moduleOptions}
                                        onrecordselect={handleModuleChange}
                                        selected-id={selectedModule}
                                        selected-name={selectedModuleName}>
                                    </c-custom-lookup> -->
                            <!-- <c-custom-lookup label="Select Module" object-api-name="Module__c"
                                    placeholder="Search Module" records-list={moduleOptions}
                                    onrecordselect={handleModuleChange} selected-id={selectedModule}
                                    selected-name={selectedModuleName} disabled={isModuleDisabled}>
                                </c-custom-lookup>
                            </div> -->
                            <div class="slds-col slds-size_1-of-2">
                                <template if:false={isEditMode}>
                                    <label class="lookup-label">
                                        Select Module <span class="required">*</span>
                                    </label>
                                    <!-- <c-custom-lookup label="Select Module" object-api-name="Module__c"
                                        placeholder="Search Module" records-list={moduleOptions}
                                        onrecordselect={handleModuleChange} selected-id={selectedModule}
                                        selected-name={selectedModuleName}>
                                    </c-custom-lookup> -->
                                    <!-- <c-custom-lookup
    label="Select Module"
    object-api-name="Module__c"
    placeholder="Search Module"
    records-list={moduleOptions}
    onrecordselect={handleModuleChange}
    selected-id={selectedModule}
    selected-name={selectedModuleName}
    disabled={isModuleDisabled}>
</c-custom-lookup> -->
                                    <c-custom-filtered-lookup placeholder="Search Module"
                                        records-list={moduleOptions} onrecordselect={handleModuleSelect}>
                                    </c-custom-filtered-lookup>

                                </template>
                                <template if:true={isEditMode}>
                                    <lightning-input label="Module" value={selectedModuleName} disabled required>
                                    </lightning-input>
                                </template>
                            </div>
                            <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                                <template if:false={isEditMode}>
                                    <label class="lookup-label">
                                        Select Team Member <span class="required">*</span>
                                    </label>
                                    <!-- <c-custom-lookup label="Select Contact" object-api-name="Contact"
                                        placeholder="Search Contact" records-list={contactOptions}
                                        onrecordselect={handleContactChange} selected-id={selectedContact}
                                        selected-name={selectedContactName}>
                                    </c-custom-lookup> -->
                                    <!-- <c-custom-lookup label="Select Contact" object-api-name="Contact"
    placeholder="Search Contact" records-list={contactOptions}
    onrecordselect={handleContactChange} selected-id={selectedContact}
    selected-name={selectedContactName} disabled={isContactDisabled}>
</c-custom-lookup> -->
                                    <c-custom-filtered-lookup
                                        placeholder="Search Team Member" records-list={contactOptions}
                                        onrecordselect={handleContactSelect} disabled={disableFilters}>
                                    </c-custom-filtered-lookup>
                                </template>
                                <template if:true={isEditMode}>
                                    <lightning-input label="Contact" value={selectedContactName} disabled required>
                                    </lightning-input>
                                </template>
                            </div>



                            <!-- <div class="slds-col slds-size_1-of-2 slds-m-top_medium"> -->
                            <!-- <c-custom-lookup label="Select Contact" object-api-name="Contact"
                                    placeholder="Search Contact" onrecordselect={handleContactChange}
                                    selected-id={selectedContact}  selected-name={selectedContactName} disabled={isEditMode}></c-custom-lookup> -->
                            <!-- <c-custom-lookup label="Select Contact"
                                        object-api-name="Contact"
                                        placeholder="Search Contact"
                                        records-list={contactOptions}
                                        onrecordselect={handleContactChange}
                                        selected-id={selectedContact}
                                        selected-name={selectedContactName}>
                                    </c-custom-lookup> -->
                            <!-- <c-custom-lookup label="Select Contact" object-api-name="Contact"
                                    placeholder="Search Contact" records-list={contactOptions}
                                    onrecordselect={handleContactChange} selected-id={selectedContact}
                                    selected-name={selectedContactName} disabled={isContactDisabled}>
                                </c-custom-lookup> -->
                            <!-- </div> -->

                            <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                                <label class="lookup-label">
                                        Select Priority <span class="required">*</span>
                                    </label>
                                <lightning-combobox options={priorityOptions}
                                    value={selectedPriority} onchange={handlePriorityChange}></lightning-combobox>

                                
                            </div>

                            <div class="slds-col slds-size_1-of-2 slds-p-around_x-small">
                                <label class="lookup-label">
                                        Task Start Date & Time <span class="required">*</span>
                                    </label>
                                <lightning-input type="datetime" value={startDateTime}
                                    onchange={handleStartDateTimeChange}></lightning-input>
                            </div>

                            <div class="slds-col slds-size_1-of-2 slds-p-around_x-small">
                                <label class="lookup-label">
                                        Task End Date & Time <span class="required">*</span>
                                    </label>
                                <lightning-input type="datetime" value={endDateTime}
                                    onchange={handleEndDateTimeChange}></lightning-input>
                            </div>

                            <div class="slds-col slds-size_2-of-2 slds-p-around_x-small">
                                <label class="lookup-label">
                                        Description <span class="required">*</span>
                                    </label>
                                <lightning-textarea value={description}
                                    onchange={handleDescriptionChange}></lightning-textarea>
                            </div>
                        </div>
                    </div>

                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" label="Cancel" onclick={closeModal}></lightning-button>
                        <lightning-button variant="brand" label={submitButtonLabel} class="slds-m-left_small"
                            onclick={handleSubmit}></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open" style="z-index:0 !important;"></div>
        </template>
        <!-- Delete Confirmation Modal -->
        <template if:true={showDeleteModal}>
            <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header slds-modal__header_empty"></header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <p class="slds-text-heading_medium">Are you sure you want to delete this task?</p>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button variant="neutral" class="slds-m-right_small" label="Cancel"
                            onclick={cancelDelete}></lightning-button>
                        <lightning-button variant="destructive" label="Delete" onclick={confirmDelete}>
                        </lightning-button>
                    </footer>

                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

    </lightning-card>

    <!-- READ-ONLY TASK DETAILS MODAL -->
    <template if:true={isReadOnlyModalOpen}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">

                <header class="slds-modal__header">
                    <h2 class="slds-text-heading_medium">Task Details</h2>
                </header>

                <div class="slds-modal__content slds-p-around_medium">
                    <div class="slds-grid slds-wrap slds-gutters">

                        <!-- PROJECT -->
                        <div class="slds-col slds-size_1-of-2">
                            <lightning-input label="Project" value={viewProject} disabled></lightning-input>
                        </div>

                        <!-- MODULE -->
                        <div class="slds-col slds-size_1-of-2">
                            <lightning-input label="Module" value={viewModule} disabled></lightning-input>
                        </div>

                        <!-- TEAM MEMBER -->
                        <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                            <lightning-input label="Team Member" value={viewTeamMember} disabled></lightning-input>
                        </div>

                        <!-- PRIORITY -->
                        <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                            <lightning-input label="Priority" value={viewPriority} disabled></lightning-input>
                        </div>

                        <!-- START DATE -->
                        <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                            <lightning-input type="datetime" label="Start Date & Time" value={viewStart} disabled>
                            </lightning-input>
                        </div>

                        <!-- END DATE -->
                        <div class="slds-col slds-size_1-of-2 slds-m-top_medium">
                            <lightning-input type="datetime" label="End Date & Time" value={viewEnd} disabled>
                            </lightning-input>
                        </div>

                        <!-- DESCRIPTION -->
                        <div class="slds-col slds-size_2-of-2 slds-m-top_medium">
                            <lightning-textarea label="Description" value={viewDescription} disabled>
                            </lightning-textarea>
                        </div>

                    </div>
                </div>

                <footer class="slds-modal__footer">
                    <lightning-button variant="neutral" label="Close" onclick={closeReadOnlyModal}></lightning-button>
                </footer>

            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>


</template>